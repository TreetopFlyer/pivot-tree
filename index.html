<style>
.Row
{
    padding-left:20px;
    overflow:hidden;
    clear:both;
}
.Row > .Name
{
    float:left;
}
.Row > .Columns
{
    float:right;
    overflow:hidden;
}
.Columns > .Cell
{
    width:120px;
    float:left;
    border:1px solid #333;
    padding:5px;

    text-align:right;
}
.Section
{
    clear:both;
}
.Pivot
{
    float:left;
    border:1px solid #000;
    margin:5px;
}
.Pivot span
{
    display:inline-block;
    padding:10px;
    margin:3px;
    background:#FC0;
}
th
{
    border-bottom:1px solid #333;
    text-align:center;
}
td
{
    text-align:right;
    padding:3px 0px 20px 10px;
}
td.Value
{
    padding-left:40px;
    background:#ddd;
    font-weight:bold;
    text-align:right;
}
td.Goal
{
    padding-right:20px;
}
</style>
<div id="App"></div>
<script type="module">
import { html, render } from 'https://unpkg.com/lit-html/lit-html.js';
import { Pivot, PivotTree, SumRows, TweakUp, TweakDown, PathDown } from './pivot.js';

var App;
App = {}
App.Model = {
    Header:["Thing", "Type", "Cost", "Count"],
    Sums:  [                 "Cost", "Count"],
    Rows:  [
            ["thing1", "a",    1,      1     ],
            ["thing1", "b",    2,      1     ],
            ["thing1", "a",    3,      2     ],
            ["thing1", "b",    4,      2     ],
            ["thing2", "a",    1,      2     ],
            ["thing2", "b",    2,      2     ],
            ["thing2", "a",    3,      2     ],
            ["thing2", "b",    4,      2     ],
            ["thing2", "a",    5,      1     ],
            ["thing2", "b",    6,      1     ],
            ["thing2", "a",    7,      1     ]
    ],
    Trees:[],
    Active:false
};
App.Methods = {
    ResolvePath: (inPath) =>
    {
        return PathDown(App.Model.Active.Root, inPath, 0);
    },
    ResolveSum: (inName) =>
    {
        var i;
        var sum;
        for(i=0; i<App.Model.Sums.length; i++)
        {
            if(App.Model.Sums[i] == inName)
            {
                return i;
            }
        }
    },
    ResolvePivot: (inArray) => 
    {
        var i, j;
        var joiner = "|>-";
        var tree;
        var check = inArray.join(joiner);
        for(i=0; i<App.Model.Trees.length; i++)
        {
            if(check == App.Model.Trees[i].Pivot.join(joiner) )
            {
                return tree;
            }
        }
        return false;
    },
    EditCreate: (inPath, inColumn, inAmount) =>
    {
        var table;
        var column;
        var sum;
        var adjust;

        table = App.Methods.ResolvePath(inPath);
        column = App.Methods.ResolveSum(inColumn);
        sum = table.Sums[column];
        if(sum.Edit)
        {

        }
        else
        {
            sum.Edit = true;
            App.Model.Active.Edits.push({Path:inPath, Sum:sum});
        }

        sum.Local += inAmount;
        adjust = (sum.Value*sum.Local) - (sum.Value);
        TweakUp(table, column, adjust);
        TweakDown(table, column);
        Render.Update(App.Model, App.Methods);
    },
    GoalCreate: (inPath, inColumn, inAmount) =>
    {
        var table;
        var column;
        var sum;
        var adjust;

        table = App.Methods.ResolvePath(inPath);
        column = App.Methods.ResolveSum(inColumn);
        sum = table.Sums[column];
        if(sum.Goal)
        {

        }
        else
        {
            App.Model.Active.Goals.push({Path:inPath, Sum:sum});
        }
        sum.Goal = inAmount;
        Render.Update(App.Model, App.Methods);
    },
    PivotCreate: (inArray) =>
    {
        var i;
        var root, tree;
        if(App.Methods.ResolvePivot(inArray))
        {
            App.Model.Active = App.Model.Trees[i];
            Render.Update(App.Model, App.Methods);
            return;
        }

        root = {
            Name:"Root",
            Header:App.Model.Header,
            Rows:App.Model.Rows,
            Parent:false,
            Sums:[]
        };
        PivotTree(root, inArray, App.Model.Sums);
        SumRows(root, App.Model.Sums);
        tree = {
            Pivot: inArray,
            Root: root,
            Nodes: root.Children,
            Goals: [],
            Edits: []
        };
        App.Model.Trees.push(tree);
        App.Model.Active = tree;
        Render.Update(App.Model, App.Methods);
    },
    PivotSelect: (inPivot)=>
    {
        App.Model.Active = inPivot;
        Render.Update(App.Model, App.Methods);
    },
    StateSave: () =>
    {
        var i, j;
        var output;
        var pivot;
        var tree;
        var record;
        var item;

        output = {
            Data:{
                Source:"",
                Destination:"",
            },
            Pivots:[]
        };

        for(i=0; i<App.Model.Trees.length; i++)
        {
            pivot = {
                Pivot:[],
                Goals:[],
                Edits:[]
            };
            output.Pivots.push(pivot);
            tree = App.Model.Trees[i];
            pivot.Pivot = tree.Pivot;
            for(j=0; j<tree.Edits.length; j++)
            {
                item = tree.Edits[j];
                pivot.Edits.push({
                    Path: item.Path,
                    Column: item.Sum.Name,
                    Amount: item.Sum.Local
                });
            }
            for(j=0; j<tree.Goals.length; j++)
            {
                item = tree.Goals[j];
                pivot.Goals.push({
                    Path: item.Path,
                    Column: item.Sum.Name,
                    Amount: item.Sum.Goal
                });
            }
        }
        console.log(JSON.stringify(output));
        return output;
    },
    StateLoad: (inState) => 
    {
        var i, j;
        var pivot;
        var item;
        for(i=0; i<inState.Pivots.length; i++)
        {
            pivot = inState.Pivots[i];
            App.Methods.PivotCreate(pivot.Pivot);
            for(j=0; j<pivot.Edits.length; j++)
            {
                item = pivot.Edits[j];
                App.Methods.EditCreate(item.Path, item.Column, item.Amount);
            }
            for(j=0; j<pivot.Goals.length; j++)
            {
                item = pivot.Goals[j];
                App.Methods.GoalCreate(item.Path, item.Column, item.Amount);
            }
        }
    }
};

var Render = {};
Render.Update = (inModel, inMethods) =>
{
    render( Render.Layout(inModel, inMethods), document.querySelector("#App"));
};
Render.Layout = (inModel, inMethods) =>
{
    return html`
    <div class="Section">
        <h3>State</h3>
        <button @click=${ ()=>{inMethods.StateSave();} }>Save</button>
    </div>
    <div class="Section">
        <h3>Pivots</h3>
        ${inModel.Trees.map( (inItem)=>{
            return Render.Pivot(inItem, inMethods);
        })}
    </div>
    <div class="Section">
        <h3>View</h3>
        ${Render.Tree(inModel, inMethods)}
        </table>
    </div>
    `;
};
Render.Pivot  = (inModel, inMethods) =>
{
    return html`
    <div class="Pivot" @click=${ ()=>{ inMethods.PivotSelect(inModel); } }>
        <div class="Order">
            <h4>Columns</h4>
            ${inModel.Pivot.map( (inItem)=>{
                return html`<span style="">${inItem}</span>`;
            })} 
        </div>
        <div class="Goals">
            <h4>Goals</h4>
            <ul>
            ${inModel.Goals.map( (inItem)=>{
                return html`<li>${inItem.Path.join("/")}.${inItem.Sum.Name}: ${inItem.Sum.Goal}</li>`;
            })} 
            </ul>
            <h4>Edits</h4>
            <ul>
            ${inModel.Edits.map( (inItem)=>{
                return html`<li>${inItem.Path.join("/")}.${inItem.Sum.Name}: ${inItem.Sum.Local}</li>`;
            })} 
            </ul>
        </div>
    </div>
    `;
};
Render.Tree = (inModel, inMethods) =>
{
    if(!inModel.Active)
    {
        return false;
    }
    return html`
    <table cellpadding="0" cellspacing="0">
    <tr>
        <th class="Column"></th>
        ${inModel.Sums.map( (inItem)=>
        {
            return html`
            <th class="Value">${inItem}</th>
            <th class="Local">(xL</th>
            <th class="Parent">xP</th>
            <th class="Child">+C</th>
            <th class="Total">=T</th>
            <th class="Goal">-G)</th>`;
        })}
    </tr>
    ${inModel.Active.Nodes.map( (inBranch)=>{
        return Render.Branch(inBranch, inMethods, []);
    })}`;
};
Render.Branch = (inModel, inMethods, inPath) =>
{
    var path = inPath.concat([inModel.Name]);
    return html`
    <tr>
        <td>
            ${path.join("/")}
        </td>
        ${inModel.Sums.map( (inItem, inIndex)=>{

            var total;
            var markupGoal;
            total = inItem.Value * inItem.Local * inItem.Parent + inItem.Child;
            if(inItem.Goal)
            {
                markupGoal = html`${inItem.Goal}`;
            }
            else
            {
                markupGoal = html`<button @click=${()=>{inMethods.GoalCreate(path, inItem.Name, 100)} }>+</button>`;
            }

            return html`
            <td class="Value" @click=${ ()=>{inMethods.EditCreate(path, inItem.Name, 1.33);} }>
                ${inItem.Value.toFixed(2)}
            </td>
            <td class="Local">${inItem.Local}</td>
            <td class="Parent">${inItem.Parent}</td>
            <td class="Child">${inItem.Child}</td>
            <td class="Total">${total.toFixed(2)}</td>
            <td class="Goal">${markupGoal}</td>
            `;
        } )}
    </tr>
    ${inModel.Children.map( (inItem)=>{
        return Render.Branch(inItem, inMethods, path);
    } )}
    `;
};

/*************************/
/*
App.Methods.PivotCreate(["Thing", "Type"]);
App.Methods.PivotCreate(["Type", "Thing"]);
*/
var state = {"Data":{"Source":"","Destination":""},"Pivots":[{"Pivot":["Thing","Type"],"Goals":[{"Path":["thing1"],"Column":"Count","Amount":100},{"Path":["thing1","a"],"Column":"Count","Amount":100}],"Edits":[{"Path":["thing1"],"Column":"Cost","Amount":10.31}]},{"Pivot":["Type","Thing"],"Goals":[{"Path":["a"],"Column":"Cost","Amount":100}],"Edits":[{"Path":["a"],"Column":"Cost","Amount":3.33},{"Path":["a","thing1"],"Column":"Cost","Amount":3.33}]}]};
App.Methods.StateLoad(state);
</script>