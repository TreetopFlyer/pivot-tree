<style>
.Row
{
    padding-left:20px;
    overflow:hidden;
    clear:both;
}
.Row > .Name
{
    float:left;
}
.Row > .Columns
{
    float:right;
    overflow:hidden;
}
.Columns > .Cell
{
    width:120px;
    float:left;
    border:1px solid #333;
    padding:5px;

    text-align:right;
}
</style>
<div id="App"></div>
<script type="module">
import { html, render } from 'https://unpkg.com/lit-html/lit-html.js';
import { Pivot, PivotTree, SumRows, TweakUp, TweakDown } from './pivot.js';

var App = {
    Pivot: ["Thing", "Type"],
    Sum: ["Cost", "Count"],
    Edits:[
        {
            Pivot:"",
            Nodes:[
                {
                    Path:"",
                    Columns:[
                        {
                            Column:"",
                            Amount:0
                        }
                    ]
                }
            ]
        }
    ],
    Model:table
};
App.Archive = {};
App.Archive.Commit = (inPivot, inPath, inColumn, inAmount) => 
{
    var edits, pivot, path, columns;
    edits = App.Edits;
    pivot = App.Archive.MatchPivot(edits, inPivot.join(" |>- "));
    path = App.Archive.MatchPath(pivot, inPath.join(" |>- "));
    columns = App.Archive.MatchColumn(path, inColumn, inAmount);
};
App.Archive.MatchPivot = (inEdits, inPivot) =>
{
    var i;
    var newNode;
    for(i in inEdits)
    {
        if(inEdits[i].Pivot == inPivot)
        {
            return inEdits[i];
        }
    }
    newNode = {Pivot:inPivot, Nodes:[]};
    inEdits.push(newNode);
    return newNode;
};
App.Archive.MatchPath = (inPivot, inPath) =>
{
    var i;
    var newNode;
    for(i in inPivot.Nodes)
    {
        if(inPivot.Nodes[i].Path == inPath)
        {
            return inPivot.Nodes[i];
        }
    }
    newNode = {Path:inPath, Columns:[]};
    inPivot.Nodes.push(newNode);
    return newNode;
};
App.Archive.MatchColumn = (inPath, inColumn, inAmount) =>
{
    var i;
    var newNode;
    for(i in inPath.Columns)
    {
        if(inPath.Columns[i].Column == inColumn)
        {
            return inPath.Columns[i];
        }
    }
    newNode = {Column:inColumn, Amount:inAmount};
    inPath.Columns.push(newNode);
    return newNode;
};
App.CreateEdit = (inTable, inColumn, inAmount) =>
{
    var i, j, k;
    var oldSum, newSum;
    var path;
    
    oldSum = inTable.Sums[inColumn];
    newSum = oldSum*inAmount;
    inTable.Sums[inColumn] = newSum;
    path = [];

    TweakUp(inTable, inColumn, newSum - oldSum, path);
    TweakDown(inTable, inColumn, inAmount);

    App.Archive.Commit(App.Pivot, path, inColumn, inAmount);    
    console.log(App.Edits);
    Render.Update();  
};
App.Remove = (inIndex) =>
{

};
App.Pivot = (inArray) =>
{
    App.Pivot = inArray;
    PivotTree(App.Model, App.Pivot, App.Sum);
    //todo: apply tweaks to leaves
    Render.Update();
};
App.Setup = (inTable, inPivots, inSums) =>
{
    App.Model = inTable;
    App.Pivot = inPivots;
    App.Sum = inSums;
    SumRows(App.Model, App.Sum);
    PivotTree(App.Model, App.Pivot, App.Sum);
    Render.Update();
};

var Render = {};
Render.Tier = (inTable, inPath, inApp) =>
{
    var path = inPath.concat([inTable.Name]);
    return html`
    <div class="Row">
        <div class="Name">
            ${inTable.Name}
        </div>
        <div class="Columns">
        ${inTable.Sums.map( (inItem, inIndex)=>{
            return html`
            <div class="Cell" @click=${ ()=>{inApp.CreateEdit(inTable, inIndex, 1.33);} }>
                ${inItem.toFixed(2)}
            </div>
            `;
        } )}
        </div>
        ${inTable.Children.map( (inItem)=>{
            return Render.Tier(inItem, path, inApp);
        } )}
    </div>
    `;
};
Render.Update = () =>
{
    render( Render.Tier(App.Model, [], App), document.querySelector("#App"));
};

/*************************/
var table = {
    Name:"test",
    Header:["Thing", "Type", "Cost", "Count"],
    Sums:[],
    Parent:false,
    Children:[],
    Rows: [
    ["thing1", "a", 1, 1],
    ["thing1", "b", 2, 1],
    ["thing1", "a", 3, 2],
    ["thing1", "b", 4, 2],
    ["thing2", "a", 1, 2],
    ["thing2", "b", 2, 2],
    ["thing2", "a", 3, 2],
    ["thing2", "b", 4, 2],
    ["thing2", "a", 5, 1],
    ["thing2", "b", 6, 1],
    ["thing2", "a", 7, 1],
    ]
};
App.Setup(table, ["Thing", "Type"], ["Cost", "Count"]);

</script>